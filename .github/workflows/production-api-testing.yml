name: Production-Ready API Testing ðŸŽ¯

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency: production_environment

env:
  NODE_VERSION: "22"
  SPRINT: "sprint5-with-bugs"
  DISABLE_LOGGING: "true"

jobs:
  api-test:
    name: ðŸ§ª API Testing Suite
    runs-on: ubuntu-22.04
    
    steps:
      - name: ðŸ“¥ Checkout âš™ï¸
        uses: actions/checkout@v4
        
      - name: ðŸ³ Start containers
        run: |
          export DISABLE_LOGGING=true
          export SPRINT=${{ env.SPRINT }}
          docker compose -f docker-compose.yml up -d --force-recreate
          
      - name: â±ï¸ Sleep for 60 seconds
        run: sleep 60s
        shell: bash
        
      - name: ðŸŒ± Create & Seed database
        run: |
          docker compose exec -T laravel-api php artisan migrate:refresh --seed
          
      - name: ðŸ” Health Check - GET Version
        run: curl -v -X GET 'http://localhost:8091/status'
        
      - name: ðŸ” Health Check - POST login
        run: |
          curl -v -X POST 'http://localhost:8091/users/login' \
          -H 'Content-Type: application/json' \
          -d '{"email":"customer@practicesoftwaretesting.com","password":"welcome01"}'
          
      - name: âš™ï¸ Install node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: âš™ï¸ Install dependencies
        run: |
          npm ci
          npm install -g newman
          
      - name: ðŸ“ Create results directory
        run: mkdir -p results
        
      - name: ðŸ§ª Authentication Tests
        run: |
          newman run collections/Authentication.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/auth-results.json
        continue-on-error: false
        
      - name: ðŸ§ª Brands Search Tests
        run: |
          newman run collections/API1-Brands-Search.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/brands-results.json
        continue-on-error: true
        
      - name: ðŸ§ª Categories Search Tests  
        run: |
          newman run collections/API2-Categories-Search.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/categories-results.json
        continue-on-error: true
        
      - name: ðŸ§ª Invoice Status Tests
        run: |
          newman run collections/API3-Invoice-Status.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/invoice-results.json
        continue-on-error: true
        
      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "## ðŸ“Š API Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results/auth-results.json ]; then
            echo "| Authentication | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Authentication | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/brands-results.json ]; then
            echo "| Brands Search | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Brands Search | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/categories-results.json ]; then
            echo "| Categories Search | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Categories Search | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/invoice-results.json ]; then
            echo "| Invoice Status | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Invoice Status | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: results/
          retention-days: 30
          
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f
