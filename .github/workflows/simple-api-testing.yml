name: Simple API Testing (Testsmith Pattern) 🚀

on:
  push:
    branches: [ main, test-api-workflow ]

concurrency: testing_environment

jobs:
  test:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout ⚙️
        uses: actions/checkout@v4
        
      - name: Start containers 🐳
        run: |
          export DISABLE_LOGGING=true
          docker compose -f docker-compose.yml up -d --force-recreate
          
      - name: Sleep for 60 seconds
        run: sleep 60s
        shell: bash
        
      - name: Create & Seed database 🌱
        run: |
          docker compose exec -T laravel-api php artisan migrate:refresh --seed
          
      - name: GET Version
        run: curl -v -X GET 'http://localhost:8091/status'
        
      - name: POST login
        run: |
          curl -v -X POST 'http://localhost:8091/users/login' \
          -H 'Content-Type: application/json' \
          -d '{"email":"customer@practicesoftwaretesting.com","password":"welcome01"}'
          
      - name: Install node ⚙️
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      - name: Install dependencies ⚙️
        run: |
          npm ci
          npm install -g newman
          
      - name: Run API Tests 🧪
        run: |
          echo "Running Newman API Tests..."
          for collection in collections/*.postman_collection.json; do
            echo "Testing $(basename "$collection")"
            newman run "$collection" \
              --environment environments/CI-Docker.postman_environment.json \
              --reporters cli || echo "Test failed but continuing..."
          done
