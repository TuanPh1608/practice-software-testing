name: Enhanced API Testing (Real-World Pattern) 🎭

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency: 
  group: production_environment
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-22.04
    
    steps:
      - name: ⚙️ Checkout
        uses: actions/checkout@v4
        
      - name: 🐳 Start containers 
        run: |
          export DISABLE_LOGGING=true
          export SPRINT=sprint5-with-bugs
          docker compose -f docker-compose.yml up -d --force-recreate
          
      - name: ⏱️ Sleep for 60 seconds
        run: sleep 60s
        shell: bash
        
      - name: 🌱 Create & Seed database
        run: |
          docker compose exec -T laravel-api php artisan migrate:refresh --seed
          
      - name: 🔍 GET Version
        run: curl -v -X GET 'http://localhost:8091/status'
        
      - name: 🔐 POST login
        run: |
          curl -v -X POST 'http://localhost:8091/users/login' \
          -H 'Content-Type: application/json' \
          -d '{"email":"customer@practicesoftwaretesting.com","password":"welcome01"}'
          
      - name: ⚙️ Install node 
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      - name: ⚙️ Install Newman dependencies
        run: |
          npm ci
          npm install -g newman
          
      - name: 🧪 Run Authentication API Tests
        run: |
          newman run collections/Authentication.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/auth-results.json
        continue-on-error: true
        
      - name: 🧪 Run Brand Search API Tests
        run: |
          newman run collections/API1-Brands-Search.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/brands-results.json
        continue-on-error: true
        
      - name: 🧪 Run Category Search API Tests
        run: |
          newman run collections/API2-Categories-Search.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/categories-results.json
        continue-on-error: true
        
      - name: 🧪 Run Invoice Status API Tests
        run: |
          newman run collections/API3-Invoice-Status.postman_collection.json \
            --environment environments/CI-Docker.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export results/invoice-results.json
        continue-on-error: true
        
      - name: 📊 Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: results/
          retention-days: 30
          
      - name: 🧹 Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f
